<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Recebimento</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="file-info.js"></script>
        <script type="module" src="atualizar.js"></script>
        <link rel="stylesheet" href="recebimento.css" />
        <style></style>
    </head>
    <body>
        <main>
            <header>
                <div class="text-content">
                    <div>Recebimento</div>
                    <div class="userBlock">
                        <img src="" alt="" id="profilePic" />
                        <div class="user-name" id="user-name">username</div>
                    </div>
                </div>

                <div class="dark-mode-toggle">
                    <input type="checkbox" id="darkModeToggle" checked />
                    <label for="darkModeToggle"></label>
                </div>
                <button id="logout-button" class="logout">Logout</button>
            </header>

            <aside id="button-container">
                <div class="logo-container">
                    <div class="logo"><img src="logoTransparente.png" alt="logo" /></div>
                </div>

                <div class="buttonsBlock">
                    <div class="buttons">
                        <button id="toggle-drop-zone">Tabela/Area de arquivo</button>

                        <input type="file" id="fileInput" style="display: none" accept=".pdf, text/xml" />
                        <button onclick="document.getElementById('fileInput').click()">Upload Arquivo</button>
                        <div class="buscar">
                            <input id="id_compra" placeholder="Digite o Id_compra:" />
                            <button id="buscarChapa">buscar</button>
                        </div>
                    </div>
                </div>
            </aside>

            <div class="block1">
                <div class="block2">
                    <div class="drop-zone" id="drop-zone">
                        <div id="drop-zoneText">
                            <div>Arraste e solte seu arquivo aqui</div>
                        </div>
                    </div>

                    <div id="tables" style="display: none" class="scrollable-table">
                        <div>
                            <h2 class="titulo">Informações da compra</h2>
                        </div>
                        <table id="bancoDados">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fornecedor</th>
                                    <th>Id_compra</th>
                                    <th>Quantidade</th>
                                    <th>Qualidade</th>
                                    <th>Largura</th>
                                    <th>Comprimento</th>
                                    <th>Onda</th>
                                    <th>Vincos</th>
                                    <th>Status</th>
                                    <th>Data prevista</th>
                                    <th>Copiar</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                        <button id="compare-tables">Comparar Tabelas</button>
                        <div style="height: 10px"></div>
                        <div class="titulo">
                            <h2>Recebimento</h2>
                        </div>
                        <table id="recebimento">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <!-- Nova coluna ID adicionada aqui -->
                                    <th>Fornecedor</th>
                                    <th>Id_compra</th>
                                    <th>Quantidade</th>
                                    <th>Qualidade</th>
                                    <th>Largura</th>
                                    <th>Comprimento</th>
                                    <th>Onda</th>
                                    <th>Vincos</th>
                                    <th>Status</th>
                                    <th>Data_recebimento</th>
                                    <th>Atualizar</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody2"></tbody>
                        </table>
                        <button id="add-line-button">addLine</button>
                    </div>
                </div>
            </div>
        </main>

        <script type="module">
            import BASE_URL from "../utils/config.js";

            if (localStorage.getItem("isLoggedIn") !== "true") {
                window.location.href = "../login/login.html";
            }

            function logout() {
                localStorage.clear();
                window.location.href = "../login/login.html";
            }
            document.getElementById("logout-button").addEventListener("click", logout);

            $("#user-name").text(localStorage.getItem("nome") || "UserName");
            var name = localStorage.getItem("nome");
            var profilePic = $("#profilePic");
            profilePic.attr("src", "https://api.dicebear.com/8.x/shapes/svg?seed=" + name);

            pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js";

            document.getElementById("fileInput").addEventListener("change", function (event) {
                var file = event.target.files[0]; // Obtenha o arquivo que foi selecionado

                if (!file) {
                    alert("Por favor, selecione um arquivo válido.");
                    return;
                }

                // Processando o arquivo conforme seu tipo
                switch (file.type) {
                    case "application/pdf":
                        processPDF(file);
                        break;
                    case "text/xml":
                        processXML(file);
                        break;
                    default:
                        alert("Formato de arquivo não suportado!");
                        break;
                }

                // Resetar o input file após o processamento para permitir a mesma seleção novamente
                event.target.value = "";
            });

            const dropZone = document.getElementById("drop-zone");

            dropZone.addEventListener("dragover", function (event) {
                event.stopPropagation();
                event.preventDefault();
                event.dataTransfer.dropEffect = "copy";
            });

            dropZone.addEventListener("drop", function (event) {
                event.stopPropagation();
                event.preventDefault();
                const file = event.dataTransfer.files[0]; // Obtenha o primeiro arquivo que foi solto

                if (!file) {
                    alert("Por favor, solte um arquivo válido.");
                    return;
                }

                switch (file.type) {
                    case "application/pdf":
                        processPDF(file);
                        break;
                    case "text/xml":
                        processXML(file);
                        break;
                    default:
                        alert("Formato de arquivo não suportado!");
                        break;
                }
            });

            function processPDF(file) {
                var reader = new FileReader();
                reader.onload = function (event) {
                    var typedarray = new Uint8Array(event.target.result);
                    extractText(typedarray);
                };
                reader.readAsArrayBuffer(file);
            }

            function processXML(file) {
                var reader = new FileReader();
                reader.onload = function (event) {
                    var xml = event.target.result;
                    parseXML(xml);
                };
                reader.readAsText(file);
            }

            function buscarChapa() {
                const idCompra = document.getElementById("id_compra").value;
                fetchChapas(idCompra);
            }
            document.getElementById("buscarChapa").addEventListener("click", buscarChapa);

            function fetchChapas(xPed) {
                clearTable(); // Limpa as tabelas antes de buscar e adicionar novos dados
                axios
                    .get(`${BASE_URL}/recebimento/${xPed}`) // Altera o ID para puxar as chapas
                    .then((response) => {
                        const data = response.data;
                        if (data && data.length > 0) {
                            document.getElementById("drop-zone").style.display = "none";
                            document.getElementById("tables").style.display = "block";
                            data.forEach((chapa) => {
                                const tableb = document.getElementById("bancoDados");
                                chapa.valor_unitario = chapa.valor_unitario.replace(",", ".");
                                chapa.valor_total = chapa.valor_total.replace(".", "").replace(",", ".");
                                chapa.quantidade_recebida = chapa.quantidade_comprada;
                                criarTable(tableb, chapa);
                            });
                        }
                    })
                    .catch((error) => {
                        alert(`chapa ${xPed} não encontrada`);
                        document.getElementById("drop-zone").style.display = "flex";
                        document.getElementById("tables").style.display = "none";
                        console.error("Erro ao buscar dados: ", error);
                    });
            }
            //criar tabelasconst tableb = document.getElementById('bancoDados').getElementsByTagName('tbody')[0];

            function clearTable() {
                clearRows(document.getElementById("tableBody")); // Limpa o tbody de bancoDados
                clearRows(document.getElementById("tableBody2")); // Limpa o tbody de recebimento
            }

            function clearRows(tbody) {
                while (tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild); // Remove todos os filhos do tbody
                }
            }

            var rowId = 0; // Variável global para manter o ID da linha
            function criarTable(table, chapaData) {
                var tbody = table.querySelector("tbody");
                var row = tbody.insertRow(-1);

                var idCell = row.insertCell(0);
                idCell.innerHTML = `<input type='text' value='${chapaData.id_chapa ? chapaData.id_chapa : ""}' class='editable-id'>`;

                var cellContents = [
                    `<input type='text' value='${chapaData.fornecedor}'>`,
                    `<input type='text' value='${chapaData.id_compra}'>`,
                    `<input type='text' class='quantity' value='${chapaData.quantidade_recebida}'>`,
                    `<input type='text' value='${chapaData.qualidade}'>`,
                    `<input type='text' value='${chapaData.largura}'>`,
                    `<input type='text' value='${chapaData.comprimento}'>`,
                    `<select>${["E", "B", "C", "BB", "BC", ""].map((type) => `<option value="${type}" ${type === chapaData.onda ? "selected" : ""}>${type}</option>`).join("")}</select>`,
                    `<select><option value="Sim" ${chapaData.vincos.toLowerCase() === "não" ? "" : "selected"}>Sim</option><option value="Não" ${chapaData.vincos.toLowerCase() === "não" ? "selected" : ""}>Não</option></select>`,
                    `<select style='width: 120px;'>${["Comprado", "Recebido", "Parcialmente", "Atrasado", "Cancelado"].map((status) => `<option ${status === chapaData.status ? "selected" : ""}>${status}</option>`).join("")}</select>`,
                ];

                cellContents.forEach((content, index) => {
                    var cell = row.insertCell(index + 1);
                    cell.innerHTML = content;
                });

                // Adicionando as células específicas baseado no ID da tabela
                if (table.id === "bancoDados") {
                    let dataPrevistaCell = row.insertCell(-1);
                    let formattedDataPrevista = chapaData.data_prevista.split("/").reverse().join("-");
                    dataPrevistaCell.innerHTML = `<input type='date' value='${formattedDataPrevista}'>`;

                    let copiarCell = row.insertCell(-1);
                    let copiarButton = document.createElement("button");
                    copiarButton.className = "recebido";
                    copiarButton.textContent = "Copiar";
                    copiarButton.addEventListener("click", function () {
                        copiarParaRecebimento(this);
                    });
                    copiarCell.appendChild(copiarButton);
                } else if (table.id === "recebimento") {
                    let dataRecebimentoCell = row.insertCell(-1);
                    let todayDate = new Date().toISOString().slice(0, 10); // Esta já está no formato correto
                    dataRecebimentoCell.innerHTML = `<input type='date' value='${todayDate}'>`;

                    let atualizarCell = row.insertCell(-1);
                    let atualizarButton = document.createElement("button");
                    atualizarButton.className = "update-button";
                    atualizarButton.textContent = "Atualizar";
                    // Add event listener for atualizarButton here if needed
                    atualizarCell.appendChild(atualizarButton);
                }
            }

            function copiarParaRecebimento(button) {
                const sourceRow = button.closest("tr"); // Encontra a linha do botão que foi clicado
                const targetTableBody = document.getElementById("tableBody2"); // Seleciona o tbody da tabela de destino
                const newRow = targetTableBody.insertRow(-1); // Cria uma nova linha no final do tbody de recebimento

                // Copia as células da linha de origem para a nova linha de destino, exceto as duas últimas
                Array.from(sourceRow.cells).forEach((cell, index) => {
                    if (index < sourceRow.cells.length - 2) {
                        // Ignora as duas últimas células
                        let newCell = newRow.insertCell(-1);
                        if (cell.querySelector("input, select")) {
                            // Copia inputs ou selects
                            if (cell.querySelector("input")) {
                                let input = cell.querySelector("input");
                                newCell.innerHTML = `<input type='${input.type}' value='${input.value}' ${input.type === "text" ? "" : "readonly"}>`;
                            } else if (cell.querySelector("select")) {
                                // Cria um novo select com as mesmas opções
                                let select = cell.querySelector("select");
                                let newSelect = document.createElement("select");
                                Array.from(select.options).forEach((option) => {
                                    let newOption = new Option(option.text, option.value, option.selected, option.selected);
                                    newSelect.appendChild(newOption);
                                });
                                newCell.appendChild(newSelect);
                            }
                        } else {
                            // Simplesmente copia o texto
                            newCell.textContent = cell.textContent;
                        }
                    }
                });

                // Adiciona células específicas para a tabela de recebimento
                let todayDate = new Date().toISOString().slice(0, 10);
                newRow.insertCell(-1).innerHTML = `<input type='date' value='${todayDate}'>`; // Data de recebimento
                newRow.insertCell(-1).innerHTML = `<button class='update-button'>Atualizar</button>`; // Botão Atualizar

                comparar();
            }

            function addLine() {
                const table = document.getElementById("recebimento");
                const tbody = table.querySelector("tbody");
                const row = tbody.insertRow(-1);
                const fields = ["ID", "Fornecedor", "Id_compra", "Quantidade", "Qualidade", "Largura", "Comprimento", "Onda", "Vincos", "Status", "Data_recebimento"];

                fields.forEach((field, index) => {
                    const cell = row.insertCell(index);
                    if (field === "Status" || field === "Onda" || field == "Vincos") {
                        // Adicionar dropdowns para campos específicos
                        let selectHTML = `<select>`;
                        if (field === "Status") {
                            selectHTML += `<option>Comprado</option><option>Recebido</option><option>Parcialmente</option>`;
                        } else if (field == "Onda") {
                            selectHTML += `<option>E</option><option>B</option><option>C</option><option>BB</option><option>BC</option>`;
                        } else {
                            selectHTML += `<option>Sim</option><option>Não</option>`;
                        }
                        selectHTML += `</select>`;
                        cell.innerHTML = selectHTML;
                    } else if (field == "Data_recebimento") {
                        cell.innerHTML = `<input type='date'>`;
                    } else {
                        cell.innerHTML = `<input type='text'>`; // Campos editáveis
                    }
                });

                // Adicionar botão de atualizar
                const updateCell = row.insertCell(-1);
                updateCell.innerHTML = `<button class='update-button'>Atualizar</button>`;
            }
            document.getElementById("add-line-button").addEventListener("click", addLine);

            function hideDropZone() {
                var dropZone = document.getElementById("drop-zone");
                var tables = document.getElementById("tables");
                if (dropZone.style.display === "none") {
                    dropZone.style.display = "flex";
                    tables.style.display = "none";
                } else {
                    dropZone.style.display = "none";
                    tables.style.display = "block";
                }
            }
            document.getElementById("toggle-drop-zone").addEventListener("click", hideDropZone);

            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) {
                            // Verifica se o nó é do tipo Element
                            // Aplica readonly aos inputs de texto e de data
                            if (node.matches('#bancoDados input[type="text"], #bancoDados input[type="date"]')) {
                                node.setAttribute("readonly", "true");
                            }
                            // Aplica disabled aos selects
                            if (node.matches("#bancoDados select")) {
                                node.setAttribute("disabled", "true");
                            }
                            // Verifica e modifica elementos filhos dentro de nó adicionado
                            node.querySelectorAll('#bancoDados input[type="text"], #bancoDados input[type="date"], #bancoDados select').forEach((child) => {
                                if (child.tagName === "INPUT" && (child.type === "text" || child.type === "date")) {
                                    child.setAttribute("readonly", "true");
                                }
                                if (child.tagName === "SELECT") {
                                    child.setAttribute("disabled", "true");
                                }
                            });
                        }
                    });
                });
            });

            // Configura o observer para observar mudanças na árvore do DOM
            observer.observe(document.body, {
                childList: true,
                subtree: true,
            });

            document.getElementById("drop-zone").addEventListener("dragover", function (event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = "copy";
            });

            document.getElementById("drop-zone").addEventListener("drop", function (event) {
                event.preventDefault();
                const file = event.dataTransfer.files[0];
                if (!file) {
                    alert("Por favor, solte um arquivo válido.");
                }
            });

            function comparar() {
                const table1 = document.getElementById("bancoDados").querySelector("tbody");
                const table2 = document.getElementById("recebimento").querySelector("tbody");

                for (let i = 0; i < table2.rows.length; i++) {
                    const row2 = table2.rows[i];
                    let foundMatch = false;

                    for (let j = 0; j < table1.rows.length; j++) {
                        const row1 = table1.rows[j];
                        let allMatch = true;

                        // Verifica as colunas de 'Quantidade' até 'Status'
                        for (let k = 4; k <= 8; k++) {
                            let cell1 = row1.cells[k].querySelector("input, select")
                                ? row1.cells[k].querySelector("input, select").value.trim().toLowerCase()
                                : row1.cells[k].textContent.trim().toLowerCase();
                            let cell2 = row2.cells[k].querySelector("input, select")
                                ? row2.cells[k].querySelector("input, select").value.trim().toLowerCase()
                                : row2.cells[k].textContent.trim().toLowerCase();

                            if (cell1 !== cell2) {
                                allMatch = false;
                                break;
                            }
                        }

                        if (allMatch) {
                            console.log(`Correspondência completa encontrada na linha ${i + 1}`);
                            foundMatch = true;
                            row2.cells[0].querySelector("input").value = row1.cells[0].querySelector("input").value;
                            validar_status(row1, row2); // Chama a função para validar e alterar o status conforme necessário
                            break;
                        }
                    }

                    if (!foundMatch) {
                        console.log(`Nenhuma correspondência completa encontrada para a linha ${i + 1}`);
                    }
                }
            }
            document.getElementById("compare-tables").addEventListener("click", comparar);

            function validar_status(rowBancoDados, rowRecebimento) {
                console.log("Validando status...");

                const quantidadeBancoDados = parseInt(rowBancoDados.cells[3].querySelector("input").value, 10);
                const quantidadeRecebimento = parseInt(rowRecebimento.cells[3].querySelector("input").value, 10);

                if (quantidadeRecebimento >= quantidadeBancoDados) {
                    rowRecebimento.cells[9].querySelector("select").value = "Recebido";
                    console.log("Status mudado para Recebido");
                } else if (quantidadeRecebimento < quantidadeBancoDados) {
                    rowRecebimento.cells[9].querySelector("select").value = "Parcialmente";
                    console.log("Status mudado para Parcialmente");
                }
            }

            function alterarTema() {
                const toggle = document.getElementById("darkModeToggle");
                const theme = toggle.checked ? "dark" : "light";
                document.documentElement.setAttribute("data-theme", theme); // Aplica o atributo de tema ao root do documento
                localStorage.setItem("theme", theme);

                // Aplica ou remove o filtro de inversão baseado no tema
                if (toggle.checked) {
                    document.querySelector(".logo img").style.filter = "invert(100%)";
                } else {
                    document.querySelector(".logo img").style.filter = "none";
                }
            }

            document.getElementById("darkModeToggle").addEventListener("change", alterarTema);

            document.addEventListener("DOMContentLoaded", () => {
                const savedTheme = localStorage.getItem("theme") || "dark"; // Assume "dark" se nada estiver salvo
                const toggle = document.getElementById("darkModeToggle");
                toggle.checked = savedTheme === "dark";
                document.documentElement.setAttribute("data-theme", savedTheme); // Aplica o tema salvo ao carregar

                // Aplica a inversão inicial com base no tema salvo
                if (savedTheme === "dark") {
                    document.querySelector(".logo img").style.filter = "invert(100%)";
                } else {
                    document.querySelector(".logo img").style.filter = "none";
                }
            });
        </script>
    </body>
</html>
